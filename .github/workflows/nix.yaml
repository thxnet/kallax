name: "Nix Flakes"

on:
  push:
    branches:
      - main
      - develop
      - release/*
      - hotfix/*
      - feature/*
      - ci/*

  pull_request:
    paths:
      - "*/src/**"
      - ".github/**"
      - "src/**"
      - Cargo.lock
      - Cargo.toml
      - flake.lock
      - flake.nix

jobs:
  build-nix-flake:
    name: Build Nix Flake
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v26
        with:
          extra_nix_config: |
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}

      - name: Build Nix Flake
        run: nix build

      - name: Test executable
        run: ./result/bin/kallax --version

      - name: Smoke test - Shell completions
        run: |
          # Test bash completions generation
          ./result/bin/kallax completions bash > /dev/null
          echo "Bash completions generated successfully"

      - name: Smoke test - Help output
        run: |
          # Test main help
          ./result/bin/kallax --help
          echo ""

          # Test subcommand help for major commands
          ./result/bin/kallax session-key --help
          echo ""

          ./result/bin/kallax initializer --help
          echo ""

          ./result/bin/kallax sidecar --help
          echo ""

          ./result/bin/kallax tracker --help
          echo ""

          ./result/bin/kallax network-broker --help
          echo ""

          echo "All help outputs generated successfully"

      - name: Smoke test - Session key dry-run
        run: |
          # Test session-key help to verify crypto library linking
          ./result/bin/kallax session-key --help
          echo ""

          # Test version command
          ./result/bin/kallax version

          echo "Session key smoke tests passed"
